<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Mystery Vietnam üîç - H·ªçc SQL qua ƒêi·ªÅu tra V·ª• √Ån</title>
    <meta name="description" content="H·ªçc SQL mi·ªÖn ph√≠ qua 50 v·ª• √°n h√¨nh s·ª± t·∫°i Vi·ªát Nam. Tr·ªü th√†nh th√°m t·ª≠, vi·∫øt SQL ƒë·ªÉ ph√° √°n!">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=JetBrains+Mono:wght@400;500;600&family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SQL.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --accent-gold: #d4af37;
            --accent-gold-dim: #9a7b1f;
            --accent-red: #8b0000;
            --accent-red-bright: #dc143c;
            --text-primary: #f5f5dc;
            --text-secondary: #a0a0a0;
            --text-dim: #606060;
            --border-color: #2a2a35;
            --success: #228b22;
            --error: #dc143c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Noir film grain effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
            z-index: 1000;
        }

        /* Header */
        header {
            background: linear-gradient(180deg, var(--bg-card) 0%, transparent 100%);
            padding: 2rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            font-weight: 900;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #fff8dc 50%, var(--accent-gold) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 60px rgba(212, 175, 55, 0.3);
            margin-bottom: 0.5rem;
        }

        .tagline {
            font-size: 1rem;
            color: var(--text-secondary);
            letter-spacing: 0.3em;
            text-transform: uppercase;
        }

        /* Main Layout */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            min-height: calc(100vh - 150px);
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        /* Sidebar - Case List */
        .sidebar {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 200px);
            position: sticky;
            top: 2rem;
        }

        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--accent-red) 0%, #5a0000 100%);
            border-bottom: 2px solid var(--accent-gold);
        }

        .sidebar-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-section {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.4rem 0.8rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--accent-gold);
            color: var(--bg-dark);
            border-color: var(--accent-gold);
        }

        .case-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .case-item {
            padding: 1rem;
            margin: 0.5rem;
            background: var(--bg-dark);
            border-radius: 8px;
            border-left: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .case-item:hover {
            background: var(--bg-card-hover);
            border-left-color: var(--accent-gold);
            transform: translateX(5px);
        }

        .case-item.active {
            background: var(--bg-card-hover);
            border-left-color: var(--accent-red-bright);
        }

        .case-item.solved {
            border-left-color: var(--success);
        }

        .case-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent-gold);
            margin-bottom: 0.3rem;
        }

        .case-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .case-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .difficulty {
            color: var(--accent-gold);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Case Detail */
        .case-detail {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .case-header {
            padding: 2rem;
            background: linear-gradient(135deg, #1a1a25 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .case-header::before {
            content: 'üîç';
            position: absolute;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 4rem;
            opacity: 0.1;
        }

        .case-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            background: var(--accent-red);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .case-detail h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .case-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .info-item {
            background: var(--bg-dark);
            padding: 0.8rem;
            border-radius: 6px;
        }

        .info-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.3rem;
        }

        .info-value {
            font-weight: 500;
            color: var(--text-primary);
        }

        .case-description {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .case-description h3 {
            font-size: 0.9rem;
            color: var(--accent-gold);
            margin-bottom: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .hint-box {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(212, 175, 55, 0.05) 100%);
            border: 1px solid var(--accent-gold-dim);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .hint-box summary {
            cursor: pointer;
            color: var(--accent-gold);
            font-weight: 500;
        }

        .hint-box p {
            margin-top: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* SQL Editor */
        .sql-section {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .sql-header {
            padding: 1rem 1.5rem;
            background: var(--bg-dark);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sql-header h3 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--accent-gold);
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-dim) 100%);
            color: var(--bg-dark);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .sql-editor-wrapper {
            position: relative;
        }

        #sql-editor {
            width: 100%;
            min-height: 150px;
            padding: 1.5rem;
            background: #0d0d12;
            border: none;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            resize: vertical;
            outline: none;
            line-height: 1.6;
        }

        #sql-editor::placeholder {
            color: var(--text-dim);
        }

        /* Results */
        .results-section {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .results-header h4 {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .results-stats {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .results-table-wrapper {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .results-table th {
            background: var(--bg-dark);
            padding: 0.8rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--accent-gold);
            border-bottom: 2px solid var(--accent-gold-dim);
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .results-table td {
            padding: 0.7rem 1rem;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .results-table tr:hover td {
            background: var(--bg-card-hover);
        }

        .error-message {
            background: linear-gradient(135deg, rgba(220, 20, 60, 0.1) 0%, rgba(220, 20, 60, 0.05) 100%);
            border: 1px solid var(--error);
            border-radius: 8px;
            padding: 1rem;
            color: var(--error);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .success-message {
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.1) 0%, rgba(34, 139, 34, 0.05) 100%);
            border: 1px solid var(--success);
            border-radius: 8px;
            padding: 1rem;
            color: var(--success);
            text-align: center;
            font-size: 1.1rem;
        }

        /* Schema Reference */
        .schema-section {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .schema-header {
            padding: 1rem 1.5rem;
            background: var(--bg-dark);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .schema-header h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .schema-content {
            padding: 1.5rem;
            display: none;
        }

        .schema-content.show {
            display: block;
        }

        .schema-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .schema-table {
            background: var(--bg-dark);
            border-radius: 8px;
            overflow: hidden;
        }

        .schema-table-name {
            padding: 0.6rem 1rem;
            background: var(--accent-gold-dim);
            color: var(--bg-dark);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .schema-columns {
            padding: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .schema-columns div {
            padding: 0.2rem 0.5rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 4rem 2rem;
        }

        .welcome-screen h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .welcome-screen p {
            color: var(--text-secondary);
            max-width: 500px;
            margin: 0 auto 2rem;
        }

        .quick-queries {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .quick-query {
            padding: 0.5rem 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .quick-query:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Keyboard shortcut hint */
        .kbd {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-dim);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
            font-size: 0.85rem;
            border-top: 1px solid var(--border-color);
        }

        footer a {
            color: var(--accent-gold);
            text-decoration: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .logo {
                font-size: 2rem;
            }

            .container {
                padding: 1rem;
            }

            .sidebar {
                position: relative;
                max-height: none;
            }

            .case-list {
                max-height: 300px;
            }

            .case-header {
                padding: 1.5rem;
            }

            .case-detail h1 {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">SQL Mystery Vietnam</div>
        <div class="tagline">H·ªçc SQL qua 50 V·ª• √Ån H√¨nh S·ª±</div>
    </header>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üìÅ H·ªì S∆° V·ª• √Ån</h2>
            </div>
            <div class="filter-section">
                <button class="filter-btn active" data-filter="all">T·∫•t c·∫£</button>
                <button class="filter-btn" data-filter="1">‚≠ê</button>
                <button class="filter-btn" data-filter="2">‚≠ê‚≠ê</button>
                <button class="filter-btn" data-filter="3">‚≠ê‚≠ê‚≠ê</button>
                <button class="filter-btn" data-filter="4">‚≠ê‚≠ê‚≠ê‚≠ê</button>
                <button class="filter-btn" data-filter="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</button>
            </div>
            <div class="case-list" id="case-list">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Case Detail -->
            <section class="case-detail" id="case-detail">
                <div class="welcome-screen">
                    <h2>üïµÔ∏è Ch√†o m·ª´ng Th√°m t·ª≠!</h2>
                    <p>S·ª≠ d·ª•ng SQL ƒë·ªÉ ƒëi·ªÅu tra v√† t√¨m ra hung th·ªß trong 50 v·ª• √°n. Ch·ªçn m·ªôt v·ª• √°n t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                    
                    <div class="quick-queries">
                        <span class="quick-query" onclick="runQuickQuery('SELECT * FROM cases LIMIT 5')">Xem 5 v·ª• √°n ƒë·∫ßu</span>
                        <span class="quick-query" onclick="runQuickQuery('SELECT name FROM sqlite_master WHERE type=\\'table\\'')">Li·ªát k√™ b·∫£ng</span>
                        <span class="quick-query" onclick="runQuickQuery('SELECT * FROM citizens LIMIT 10')">Xem 10 c√¥ng d√¢n</span>
                    </div>
                </div>
            </section>

            <!-- SQL Editor -->
            <section class="sql-section">
                <div class="sql-header">
                    <h3>üíª SQL Console</h3>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="clearEditor()">X√≥a</button>
                        <button class="btn btn-primary" onclick="executeSQL()">
                            ‚ñ∂ Ch·∫°y <span class="kbd">Ctrl+Enter</span>
                        </button>
                    </div>
                </div>
                <div class="sql-editor-wrapper">
                    <textarea id="sql-editor" placeholder="-- Vi·∫øt SQL query c·ªßa b·∫°n ·ªü ƒë√¢y&#10;-- V√≠ d·ª•: SELECT * FROM cases WHERE difficulty = 1;"></textarea>
                </div>
                <div class="results-section" id="results-section">
                    <div class="results-header">
                        <h4>üìä K·∫øt qu·∫£</h4>
                        <span class="results-stats" id="results-stats"></span>
                    </div>
                    <div id="results-content">
                        <p style="color: var(--text-dim); text-align: center; padding: 2rem;">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
                    </div>
                </div>
            </section>

            <!-- Schema Reference -->
            <section class="schema-section">
                <div class="schema-header" onclick="toggleSchema()">
                    <h3>üìã Schema Reference (Click ƒë·ªÉ m·ªü)</h3>
                    <span id="schema-toggle">‚ñº</span>
                </div>
                <div class="schema-content" id="schema-content">
                    <div class="schema-grid" id="schema-grid">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <footer>
        <p>SQL Mystery Vietnam - D·ª± √°n h·ªçc SQL mi·ªÖn ph√≠ | 
        <a href="https://github.com" target="_blank">GitHub</a> | 
        Inspired by <a href="https://mystery.knightlab.com/" target="_blank">SQL Murder Mystery</a></p>
    </footer>

    <script>
        let db = null;
        let currentCase = null;
        let solvedCases = JSON.parse(localStorage.getItem('solvedCases') || '[]');

        // Database schema for reference
        const schemaInfo = {
            'cases': ['id', 'case_number', 'case_type', 'title', 'description', 'location', 'district_id', 'crime_date', 'crime_time', 'status', 'difficulty', 'solution_hint', 'culprit_id'],
            'citizens': ['id', 'name', 'gender', 'birth_date', 'id_card', 'address', 'district_id', 'occupation', 'phone', 'email', 'height', 'weight', 'blood_type', 'license_plate', 'income_level'],
            'victims': ['id', 'case_id', 'citizen_id', 'injury_type', 'status'],
            'suspects': ['id', 'case_id', 'citizen_id', 'motive', 'alibi', 'is_culprit'],
            'witnesses': ['id', 'case_id', 'citizen_id', 'testimony', 'reliability', 'interview_date'],
            'evidence': ['id', 'case_id', 'evidence_type', 'description', 'location_found', 'found_date', 'analyzed', 'analysis_result'],
            'relationships': ['id', 'citizen1_id', 'citizen2_id', 'relationship_type'],
            'criminal_records': ['id', 'citizen_id', 'crime_type', 'conviction_date', 'sentence', 'release_date'],
            'phone_calls': ['id', 'caller_id', 'receiver_id', 'call_date', 'call_time', 'duration_seconds'],
            'bank_transactions': ['id', 'citizen_id', 'transaction_type', 'amount', 'transaction_date', 'transaction_time', 'location'],
            'gym_members': ['id', 'citizen_id', 'gym_name', 'membership_type', 'start_date'],
            'gym_checkins': ['id', 'member_id', 'checkin_date', 'checkin_time', 'checkout_time'],
            'vehicles': ['id', 'citizen_id', 'license_plate', 'vehicle_type', 'brand', 'color', 'year'],
            'camera_records': ['id', 'camera_id', 'license_plate', 'record_date', 'record_time'],
            'hotel_bookings': ['id', 'hotel_id', 'citizen_id', 'room_number', 'checkin_date', 'checkout_date'],
            'flights': ['id', 'flight_number', 'departure_city', 'arrival_city', 'departure_date'],
            'flight_passengers': ['id', 'flight_id', 'citizen_id', 'seat_number', 'class'],
            'employees': ['id', 'citizen_id', 'company_id', 'position', 'department', 'salary'],
            'districts': ['id', 'name', 'city_id'],
            'cities': ['id', 'name', 'region', 'population']
        };

        // Initialize
        async function init() {
            try {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });

                // Fetch database
                const response = await fetch('sql_mystery_vietnam.db');
                const buffer = await response.arrayBuffer();
                db = new SQL.Database(new Uint8Array(buffer));

                loadCases();
                renderSchema();
                
            } catch (error) {
                console.error('Error initializing:', error);
                document.getElementById('case-list').innerHTML = `
                    <div class="error-message" style="margin: 1rem;">
                        Kh√¥ng th·ªÉ t·∫£i database. Vui l√≤ng refresh trang.<br>
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        // Load cases
        function loadCases() {
            const results = db.exec("SELECT id, case_number, title, case_type, difficulty FROM cases ORDER BY id");
            if (results.length === 0) return;

            const cases = results[0].values;
            const caseList = document.getElementById('case-list');
            
            caseList.innerHTML = cases.map(c => {
                const isSolved = solvedCases.includes(c[0]);
                return `
                    <div class="case-item ${isSolved ? 'solved' : ''}" data-id="${c[0]}" data-difficulty="${c[4]}" onclick="selectCase(${c[0]})">
                        <div class="case-number">${c[1]}</div>
                        <div class="case-title">${c[2]}</div>
                        <div class="case-meta">
                            <span>${c[3]}</span>
                            <span class="difficulty">${'‚≠ê'.repeat(c[4])}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select case
        function selectCase(id) {
            const results = db.exec(`SELECT * FROM cases WHERE id = ${id}`);
            if (results.length === 0) return;

            const columns = results[0].columns;
            const values = results[0].values[0];
            const caseData = {};
            columns.forEach((col, i) => caseData[col] = values[i]);

            currentCase = caseData;

            // Update UI
            document.querySelectorAll('.case-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.case-item[data-id="${id}"]`).classList.add('active');

            document.getElementById('case-detail').innerHTML = `
                <div class="case-header">
                    <span class="case-badge">${caseData.case_type}</span>
                    <h1>${caseData.title}</h1>
                    <div class="case-info">
                        <div class="info-item">
                            <div class="info-label">M√£ v·ª• √°n</div>
                            <div class="info-value">${caseData.case_number}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Ng√†y x·∫£y ra</div>
                            <div class="info-value">${caseData.crime_date}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ƒê·ªãa ƒëi·ªÉm</div>
                            <div class="info-value">${caseData.location}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ƒê·ªô kh√≥</div>
                            <div class="info-value">${'‚≠ê'.repeat(caseData.difficulty)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Tr·∫°ng th√°i</div>
                            <div class="info-value">${caseData.status}</div>
                        </div>
                    </div>
                </div>
                <div class="case-description">
                    <h3>üìù M√¥ t·∫£ v·ª• √°n</h3>
                    <p>${caseData.description}</p>
                    
                    <details class="hint-box">
                        <summary>üí° G·ª£i √Ω ƒëi·ªÅu tra (Click ƒë·ªÉ xem)</summary>
                        <p>${caseData.solution_hint}</p>
                    </details>
                </div>
                <div style="padding: 1.5rem 2rem;">
                    <h3 style="font-size: 0.9rem; color: var(--accent-gold); margin-bottom: 1rem;">üîç B·∫Øt ƒë·∫ßu ƒëi·ªÅu tra</h3>
                    <div class="quick-queries">
                        <span class="quick-query" onclick="runQuickQuery('SELECT c.name, v.injury_type, v.status FROM victims v JOIN citizens c ON v.citizen_id = c.id WHERE v.case_id = ${id}')">Xem n·∫°n nh√¢n</span>
                        <span class="quick-query" onclick="runQuickQuery('SELECT c.name, s.motive, s.alibi FROM suspects s JOIN citizens c ON s.citizen_id = c.id WHERE s.case_id = ${id}')">Xem nghi ph·∫°m</span>
                        <span class="quick-query" onclick="runQuickQuery('SELECT c.name, w.testimony FROM witnesses w JOIN citizens c ON w.citizen_id = c.id WHERE w.case_id = ${id}')">Xem nh√¢n ch·ª©ng</span>
                        <span class="quick-query" onclick="runQuickQuery('SELECT * FROM evidence WHERE case_id = ${id}')">Xem b·∫±ng ch·ª©ng</span>
                    </div>
                </div>
            `;

            // Set initial query
            document.getElementById('sql-editor').value = `-- V·ª• √°n #${id}: ${caseData.title}\n-- B·∫Øt ƒë·∫ßu ƒëi·ªÅu tra!\n\nSELECT * FROM cases WHERE id = ${id};`;
        }

        // Execute SQL
        function executeSQL() {
            const sql = document.getElementById('sql-editor').value.trim();
            if (!sql) return;

            const resultsContent = document.getElementById('results-content');
            const resultsStats = document.getElementById('results-stats');

            try {
                const startTime = performance.now();
                const results = db.exec(sql);
                const endTime = performance.now();

                if (results.length === 0) {
                    resultsContent.innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 2rem;">Query th·ª±c thi th√†nh c√¥ng nh∆∞ng kh√¥ng c√≥ k·∫øt qu·∫£.</p>';
                    resultsStats.textContent = `${(endTime - startTime).toFixed(2)}ms`;
                    return;
                }

                const { columns, values } = results[0];
                resultsStats.textContent = `${values.length} d√≤ng | ${(endTime - startTime).toFixed(2)}ms`;

                // Check if user found the culprit
                if (currentCase && sql.toLowerCase().includes('is_culprit') && values.some(row => row.includes(1))) {
                    const culpritRow = values.find(row => row.includes(1));
                    if (culpritRow) {
                        markCaseSolved(currentCase.id);
                    }
                }

                let tableHTML = `
                    <div class="results-table-wrapper">
                        <table class="results-table">
                            <thead>
                                <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
                            </thead>
                            <tbody>
                                ${values.map(row => `<tr>${row.map(cell => `<td>${cell === null ? '<span style="color: var(--text-dim)">NULL</span>' : cell}</td>`).join('')}</tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                resultsContent.innerHTML = tableHTML;

            } catch (error) {
                resultsContent.innerHTML = `<div class="error-message">‚ùå L·ªói SQL: ${error.message}</div>`;
                resultsStats.textContent = '';
            }
        }

        // Mark case as solved
        function markCaseSolved(caseId) {
            if (!solvedCases.includes(caseId)) {
                solvedCases.push(caseId);
                localStorage.setItem('solvedCases', JSON.stringify(solvedCases));
                
                const caseItem = document.querySelector(`.case-item[data-id="${caseId}"]`);
                if (caseItem) caseItem.classList.add('solved');

                // Show success message
                const resultsContent = document.getElementById('results-content');
                resultsContent.innerHTML = `
                    <div class="success-message">
                        üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ t√¨m ra hung th·ªß!
                    </div>
                ` + resultsContent.innerHTML;
            }
        }

        // Quick query
        function runQuickQuery(sql) {
            document.getElementById('sql-editor').value = sql;
            executeSQL();
        }

        // Clear editor
        function clearEditor() {
            document.getElementById('sql-editor').value = '';
            document.getElementById('results-content').innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 2rem;">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>';
            document.getElementById('results-stats').textContent = '';
        }

        // Toggle schema
        function toggleSchema() {
            const content = document.getElementById('schema-content');
            const toggle = document.getElementById('schema-toggle');
            content.classList.toggle('show');
            toggle.textContent = content.classList.contains('show') ? '‚ñ≤' : '‚ñº';
        }

        // Render schema
        function renderSchema() {
            const grid = document.getElementById('schema-grid');
            grid.innerHTML = Object.entries(schemaInfo).map(([table, columns]) => `
                <div class="schema-table">
                    <div class="schema-table-name">${table}</div>
                    <div class="schema-columns">
                        ${columns.map(col => `<div>‚Ä¢ ${col}</div>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Filter cases
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                
                const filter = e.target.dataset.filter;
                document.querySelectorAll('.case-item').forEach(item => {
                    if (filter === 'all' || item.dataset.difficulty === filter) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
        });

        // Keyboard shortcut
        document.getElementById('sql-editor').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                executeSQL();
            }
        });

        // Initialize
        init();
    </script>
</body>
</html>
